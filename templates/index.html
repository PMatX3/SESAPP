<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <style>
        body {
            font-family: 'Roboto', sans-serif;
            /* Material Design prefers Roboto */
            overflow-x: hidden;
            /* Prevents horizontal scroll */
        }

        /* Existing styles modified for Material Design */
        .navbar,
        .btn {
            background-color: #6200ea;
            /* Primary color */
            color: white;
            /* Text color */
        }

        .btn {
            border: none;
            border-radius: 4px;
            /* Rounded corners */
            transition: background-color 0.3s;
            /* Smooth background transition */
        }

        .btn:hover {
            background-color: #7b1fa2;
            /* Darker shade for hover effect */
        }

        /* Sidebar toggle button */
        .sidebar-toggle {
            font-size: 24px;
            /* Icon size */
            cursor: pointer;
            position: absolute;
            top: 20px;
            left: 220px;
            /* Adjust based on sidebar width */
            transition: left 0.3s;
            /* Smooth transition */
            z-index: 1000;
            /* Ensure it's above other content */
        }

        /* Updated sidebar styles for animation */
        .sidebar {
            transition: transform 0.3s ease-in-out;
            transform: translateX(0);
        }

        /* Sidebar hidden state */
        .sidebar-hidden {
            transform: translateX(-100%);
        }

        /* Loader overlay */
        .overlay {
            position: fixed;
            display: none;
            /* Hidden by default */
            width: 100%;
            height: 100%;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            /* Black with opacity */
            z-index: 999;
            /* Ensure it's on top */
            cursor: not-allowed;
        }

        /* Show the loader and overlay */
        .show {
            display: block;
        }

        .loader {
            border: 16px solid #f3f3f3;
            /* Light grey */
            border-top: 16px solid #3498db;
            /* Blue */
            border-radius: 50%;
            width: 120px;
            height: 120px;
            animation: spin 2s linear infinite;
            display: none;
            /* Hidden by default */
            position: absolute;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        .small-loader {
            display: none;
            /* Hidden by default */
            width: 20px;
            height: 20px;
            border: 3px solid rgba(58, 20, 226, 0.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin2 1s ease-in-out infinite;
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
            margin-top: 5px;
            /* Adjust spacing between button and loader */
        }

        @keyframes spin2 {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        .chat-message {
            padding: 1.5rem;
            border-radius: 0.5rem;
            margin-bottom: 1rem;
            display: flex
        }

        .chat-message.user {
            background-color: #2b313e
        }

        .chat-message.bot {
            background-color: #475063
        }

        .chat-message .avatar {
            width: 20%;
        }

        .chat-message .avatar img {
            max-width: 78px;
            max-height: 78px;
            border-radius: 50%;
            object-fit: cover;
        }

        .chat-message .message {
            width: 80%;
            padding: 0 1.5rem;
            color: #fff;
        }
    </style>
</head>

<body>

    <div class="navbar">
        <span>Logo</span>
        <button class="btn" onclick="location.href='{{ 'logout' if session.get('user_id') else 'login' }}'">
            {{ 'Logout' if session.get('user_id') else 'Login' }}
        </button>
    </div>
    <div class="loader" id="loader"></div> <!-- Loader element -->
    <div class="sidebar">
        <input type="file" id="pdf-upload" accept="application/pdf"><label for="pdf-upload">Upload PDF</label><br>
        <input type="file" id="csv-upload" accept=".csv"><label for="csv-upload">Upload CSV</label><br>
        <input type="checkbox" id="recruitly-data"><label for="recruitly-data">Use recruitly.io data</label><br>
        <button class="btn" id="process-btn">Process</button><br>
        <div class="small-loader" id="small-loader"></div>
        <button class="btn" id="new-chat-btn" onclick="location.href='{{ url_for('new_chat') }}'">New Chat</button>
        <h3>Chat History</h3>
        <ul id="chat-history"></ul>
    </div>

    <div class="content">
        <h1>Your Best Candidate AI</h1>
        <span>Type your question about your documents here:</span>
        <div class="input-group">
            <input type="text" id="question-input" placeholder="Ask a question...">
            <button class="btn" id="ask-btn">Ask</button>
        </div>
        <div id="messages"></div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            document.getElementById('process-btn').addEventListener('click', function () {
                var loader = document.getElementById('small-loader');
                var pdfInput = document.getElementById('pdf-upload');
                var csvInput = document.getElementById('csv-upload');
                var recruitlyDataCheckbox = document.getElementById('recruitly-data'); // Get the checkbox for recruitly.io data
                var formData = new FormData();
                var file;
                var type;

                // Check if the recruitly.io data checkbox is checked
                if (recruitlyDataCheckbox.checked) {
                    file = null;
                    type = 'json'; // Set type to 'json' if recruitly data is to be used
                } else {
                    // Determine which file input has a file and set the type accordingly
                    if (pdfInput.files.length > 0) {
                        file = pdfInput.files[0];
                        type = 'pdf';
                    } else if (csvInput.files.length > 0) {
                        file = csvInput.files[0];
                        type = 'csv';
                    } else {
                        file = null;
                        type = null; // No file selected and recruitly data not used
                    }
                }

                // If a file was selected or recruitly data is used, append it to formData
                if (file || type === 'json') {
                    if (file) {
                        formData.append('file', file);
                    }
                    formData.append('type', type);

                    // Show the loader
                    if (loader) loader.style.display = 'block';

                    // Make the AJAX request
                    fetch('/load_data', {
                        method: 'POST',
                        body: formData,
                    })
                        .then(response => response.json())
                        .then(data => {
                            console.log(data);
                            // Hide the loader
                            if (loader) loader.style.display = 'none';
                        })
                        .catch(error => {
                            console.error('Error:', error);
                            // Hide the loader
                            if (loader) loader.style.display = 'none';
                        });
                } else {
                    console.log('No file selected and recruitly data not used.');
                    // Optionally, hide the loader here if no file is selected and recruitly data not used
                    if (loader) loader.style.display = 'none';
                }
            });

            function getChatHistory() {
                fetch('/get_chat_history', {
                    method: 'GET',
                })
                    .then(response => response.json())
                    .then(chatHistory => {
                        console.log(chatHistory); // Process and display the chat history
                        displayChatHistory(chatHistory); // Assuming you have a function to display chat history
                    })
                    .catch(error => {
                        console.error('Error:', error);
                    });
            }

            // Call getChatHistory when the page loads to fetch chat history immediately
            getChatHistory();

            document.getElementById('ask-btn').addEventListener('click', function () {
                var questionInput = document.getElementById('question-input');
                var question = questionInput.value.trim(); // Trim whitespace

                if (question === '') {
                    console.log('Please enter a question.');
                    return;
                }

                var formData = new FormData();
                formData.append('question', question);

                // Show loader and overlay
                var loader = document.getElementById('loader');
                var overlay = document.querySelector('.overlay');
                loader.style.display = 'block';
                overlay.style.display = 'block';

                // Make a request to /ask
                fetch('/ask', {
                    method: 'POST',
                    body: formData,
                })
                    .then(response => response.json())
                    .then(data => {
                        console.log(data); // Log the response from /ask

                        // After processing /ask, request the updated chat history
                        getChatHistory(); // Call getChatHistory to fetch and display the updated chat history
                    })
                    .catch(error => {
                        console.error('Error:', error);
                    })
                    .finally(() => {
                        // Hide loader and overlay regardless of success or failure
                        loader.style.display = 'none';
                        overlay.style.display = 'none';
                    });
            });

            const sidebarToggle = document.createElement('span');
            sidebarToggle.classList.add('material-icons', 'sidebar-toggle');
            sidebarToggle.textContent = 'menu';
            document.body.appendChild(sidebarToggle);

            sidebarToggle.addEventListener('click', function () {
                document.querySelector('.sidebar').classList.toggle('sidebar-hidden');
                // Adjust toggle button position based on sidebar state
                this.style.left = document.querySelector('.sidebar').classList.contains('sidebar-hidden') ? '20px' : '220px';
            });

            // Overlay for loader
            const overlay = document.createElement('div');
            overlay.classList.add('overlay');
            document.body.appendChild(overlay);

            // Function to fetch chat history and display it
            function fetchChatHistory() {
                fetch('/chats', {
                    method: 'GET'
                })
                    .then(response => response.json())
                    .then(data => {
                        displayChatHistory2(data);
                    })
                    .catch(error => {
                        console.error('Error fetching chat history:', error);
                    });
            }

            // Function to display chat history
            function displayChatHistory2(chatHistory) {
                const chatHistoryList = document.getElementById('chat-history');
                chatHistoryList.innerHTML = ''; // Clear existing entries
                chatHistory.chat_list.forEach(chat => {

                    const listItem = document.createElement('li');
                    listItem.textContent = chat.first_question;
                    listItem.style.cursor = 'pointer';
                    listItem.onclick = function () {
                        postChat(chat.chat_id);
                    };
                    chatHistoryList.appendChild(listItem);
                });
            }

            // Function to handle click on chat history item
            function postChat(chatId) {
                console.log('Inner chat id', chatId)
                fetch('/chats', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ chat_id: chatId })
                })
                    .then(response => response.json())
                    .then(data => {
                        displayChatHistory(data.chat_history)
                    })
                    .catch(error => {
                        console.error('Error posting chat:', error);
                    });
            }
            // Function to display chat history
            function displayChatHistory(data) {
                const messagesDiv = document.getElementById('messages');
                messagesDiv.innerHTML = ''; // Clear existing messages

                // Ensure data is an array
                if (Array.isArray(data)) {
                    data.forEach(entry => {
                        // For each entry, create a message for the user and the AI
                        const userMessage = entry.user;
                        const aiMessage = entry.ai;

                        // User message box
                        const userMessageBox = document.createElement('div');
                        userMessageBox.innerHTML = userMessage;
                        messagesDiv.appendChild(userMessageBox);

                        // AI message box
                        const aiMessageBox = document.createElement('div');
                        aiMessageBox.innerHTML = aiMessage;
                        messagesDiv.appendChild(aiMessageBox);
                    });
                } else {
                    console.error('Expected data to be an array, but got:', data);
                }

                // Optionally, clear the input field after displaying the messages
                document.getElementById('question-input').value = '';
            }
            // Initial call to fetch and display chat history
            fetchChatHistory();
        });
    </script>

</body>

</html>